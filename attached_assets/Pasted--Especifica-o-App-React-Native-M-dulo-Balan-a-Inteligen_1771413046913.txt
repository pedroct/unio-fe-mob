# EspecificaÃ§Ã£o â€” App React Native: MÃ³dulo BalanÃ§a Inteligente

**Data:** 18/02/2026  
**Projeto:** UNIO Performance OS  
**Tipo:** App companion (React Native) â€” mÃ³dulo nutriÃ§Ã£o/balanÃ§a BLE

---

## 1) Contexto e decisÃ£o arquitetural

### Por que um segundo app?

A arquitetura original do UNIO prevÃª **dois frontends**:

| Frontend | Stack | FunÃ§Ã£o |
|----------|-------|--------|
| **Web app** | React 19 + Vite + Tailwind | Dashboard, diÃ¡rio, treino, hidrataÃ§Ã£o, suplementaÃ§Ã£o, perfil |
| **App mobile** | React Native (bare workflow) | BLE (balanÃ§as), HealthKit, offline-first |

O time Replit construiu o **web app** (React + Vite), que funciona perfeitamente no navegador. PorÃ©m, a integraÃ§Ã£o BLE com a balanÃ§a de cozinha **exige um app nativo** instalado no celular â€” nÃ£o Ã© possÃ­vel via browser (Web Bluetooth nÃ£o funciona no Safari/iOS e tem suporte limitado).

### Escopo deste app (MVP)

**IncluÃ­do:**
- ConexÃ£o BLE com a balanÃ§a de cozinha ICOMON (KP2048B)
- Leitura de peso em tempo real
- Busca de alimentos (base app + TBCA)
- Registro alimentar via pesagem
- Fila de pesagens pendentes

**NÃ£o incluÃ­do (futuro):**
- BalanÃ§a corporal Xiaomi BLE (mÃ³dulo biometria)
- HealthKit/Google Fit sync
- DiÃ¡rio alimentar completo (permanece no web app)
- SuplementaÃ§Ã£o, treino, hidrataÃ§Ã£o

### CoexistÃªncia com o web app

Ambos os apps compartilham:
- Mesmo backend Django (API `staging.unio.tec.br` / `api.unio.tec.br`)
- Mesma autenticaÃ§Ã£o JWT (`/api/auth/pair`)
- Mesmos endpoints, schemas e dados
- Mesmo usuÃ¡rio pode usar ambos simultaneamente

---

## 2) Stack tecnolÃ³gica

```
React Native 0.76+ (New Architecture / Fabric)
â”œâ”€â”€ TypeScript (obrigatÃ³rio)
â”œâ”€â”€ react-native-ble-plx        â†’ BLE (balanÃ§a ICOMON)
â”œâ”€â”€ @react-navigation/native    â†’ NavegaÃ§Ã£o
â”œâ”€â”€ @react-navigation/stack     â†’ Stack navigator
â”œâ”€â”€ axios ou fetch               â†’ HTTP para API
â”œâ”€â”€ @react-native-async-storage â†’ JWT persistido
â”œâ”€â”€ react-native-reanimated     â†’ AnimaÃ§Ãµes (indicador BLE)
â””â”€â”€ zustand ou jotai             â†’ Estado global (leve)
```

### Por que bare workflow (sem Expo managed)?

- `react-native-ble-plx` requer mÃ³dulos nativos (bridge Objective-C/Java)
- Expo Go nÃ£o suporta BLE
- EAS build funciona, mas bare workflow dÃ¡ controle total sobre o mÃ³dulo nativo BLE
- DistribuiÃ§Ã£o via TestFlight (iOS) e APK/bundle (Android)

---

## 3) Estrutura do projeto

```
unio-balanca/
â”œâ”€â”€ android/                     # Projeto nativo Android
â”œâ”€â”€ ios/                         # Projeto nativo iOS
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.tsx                  # Entry point, navigator
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ cliente.ts           # Axios/fetch configurado com JWT
â”‚   â”‚   â”œâ”€â”€ autenticacao.ts      # Login, refresh, logout
â”‚   â”‚   â”œâ”€â”€ nutricao.ts          # Endpoints de nutriÃ§Ã£o
â”‚   â”‚   â””â”€â”€ tipos.ts             # Types gerados da OpenAPI
â”‚   â”œâ”€â”€ ble/
â”‚   â”‚   â”œâ”€â”€ gerenciador.ts       # BleManager wrapper singleton
â”‚   â”‚   â”œâ”€â”€ icomon.ts            # Protocolo ICOMON (decode)
â”‚   â”‚   â”œâ”€â”€ constantes.ts        # UUIDs, MAC, comandos ativaÃ§Ã£o
â”‚   â”‚   â””â”€â”€ tipos.ts             # Types BLE
â”‚   â”œâ”€â”€ telas/
â”‚   â”‚   â”œâ”€â”€ Login.tsx            # Tela de autenticaÃ§Ã£o
â”‚   â”‚   â”œâ”€â”€ BalancaInteligente.tsx  # Tela principal (peso + busca)
â”‚   â”‚   â”œâ”€â”€ BuscaAlimento.tsx    # Busca com fallback TBCA
â”‚   â”‚   â””â”€â”€ Confirmacao.tsx      # Associar peso â†’ alimento
â”‚   â”œâ”€â”€ componentes/
â”‚   â”‚   â”œâ”€â”€ IndicadorBluetooth.tsx  # Status BLE (4 estados)
â”‚   â”‚   â”œâ”€â”€ CartaoAlimento.tsx      # Item de resultado de busca
â”‚   â”‚   â”œâ”€â”€ DisplayPeso.tsx         # Peso grande no centro
â”‚   â”‚   â””â”€â”€ BotaoAcao.tsx           # BotÃ£o estilizado
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useBalancaBLE.ts     # Hook: scan â†’ connect â†’ peso
â”‚   â”‚   â”œâ”€â”€ useAutenticacao.ts   # Hook: JWT, login, refresh
â”‚   â”‚   â””â”€â”€ usePesagensPendentes.ts  # Hook: fila de pesagens
â”‚   â”œâ”€â”€ estado/
â”‚   â”‚   â””â”€â”€ store.ts             # Zustand store (JWT, BLE status, peso)
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ codificacao.ts       # hexâ†”bytesâ†”base64
â”‚       â””â”€â”€ formatacao.ts        # Formatar peso, unidade
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ babel.config.js
â”œâ”€â”€ metro.config.js
â””â”€â”€ README.md
```

---

## 4) Telas e navegaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NAVEGAÃ‡ÃƒO                            â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     JWT vÃ¡lido?     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Login   â”‚ â”€â”€â”€â”€ sim â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ BalancaInteligente â”‚ â”‚
â”‚  â”‚          â”‚                     â”‚                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  [Peso: 124g]      â”‚ â”‚
â”‚                                   â”‚  [Buscar alimento] â”‚ â”‚
â”‚                                   â”‚  [ğŸ”µ Buscando...]  â”‚ â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                            â”‚              â”‚
â”‚                                    toque em "Buscar"      â”‚
â”‚                                            â”‚              â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                   â”‚  BuscaAlimento     â”‚ â”‚
â”‚                                   â”‚                    â”‚ â”‚
â”‚                                   â”‚  [Campo de busca]  â”‚ â”‚
â”‚                                   â”‚  [Lista resultados]â”‚ â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                            â”‚              â”‚
â”‚                                    seleciona alimento     â”‚
â”‚                                            â”‚              â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                   â”‚  Confirmacao       â”‚ â”‚
â”‚                                   â”‚                    â”‚ â”‚
â”‚                                   â”‚  Frango: 124g      â”‚ â”‚
â”‚                                   â”‚  Calorias: 204kcal â”‚ â”‚
â”‚                                   â”‚  [Confirmar]       â”‚ â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.1 Tela: Login

**FunÃ§Ã£o:** Autenticar o usuÃ¡rio e persistir o JWT.

| Elemento | Tipo | DescriÃ§Ã£o |
|----------|------|-----------|
| Campo email | TextInput | Email do usuÃ¡rio |
| Campo senha | TextInput (secure) | Senha |
| BotÃ£o "Entrar" | TouchableOpacity | Chama `POST /api/auth/pair` |
| Mensagem erro | Text | "Credenciais invÃ¡lidas" se 401 |

**Fluxo:**
1. UsuÃ¡rio digita email/senha â†’ `POST /api/auth/pair`
2. Resposta: `{ "access": "...", "refresh": "..." }`
3. Salvar `access` e `refresh` em AsyncStorage
4. Navegar para `BalancaInteligente`

**Refresh automÃ¡tico:**
- Se qualquer request retornar 401, tentar refresh com `POST /api/auth/refresh`
- Se refresh falhar, voltar para Login

### 4.2 Tela: BalancaInteligente (principal)

**FunÃ§Ã£o:** Conectar na balanÃ§a BLE, exibir peso em tempo real, iniciar busca de alimento.

**Layout:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Voltar    BalanÃ§a     ğŸ”µ BLE    â”‚  â† Header + IndicadorBluetooth
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                     â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚           â”‚   124.5   â”‚             â”‚  â† DisplayPeso (grande)
â”‚           â”‚   gramas  â”‚             â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Buscar alimento (ex: Frango)   â”‚â”‚  â† Campo de busca (abre BuscaAlimento)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€ Pesagens pendentes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 124.5g  â€¢  Aguardando alimento â”‚ â”‚  â† Lista de pesagens pendentes
â”‚  â”‚  83.9g  â€¢  Aguardando alimento â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  [Pesar novamente]  [Cancelar]      â”‚  â† AÃ§Ãµes
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Comportamento:**
- Ao abrir, inicia scan BLE automaticamente (hook `useBalancaBLE`)
- IndicadorBluetooth mostra estado em tempo real (4 estados)
- Quando peso estÃ¡vel chega via BLE:
  - Exibe em `DisplayPeso`
  - Envia `POST /api/nutricao/diario/balanca-cozinha` (sem alimento)
  - Pesagem aparece na lista de pendentes
- Campo de busca abre `BuscaAlimento` (push na stack)

### 4.3 Tela: BuscaAlimento

**FunÃ§Ã£o:** Buscar alimento com fallback TBCA, selecionar para associar Ã  pesagem.

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Voltar    Buscar Alimento        â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ” Digite o nome do alimento   â”‚â”‚  â† Campo com debounce 300ms
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  Fonte: Base UNIO | TBCA            â”‚  â† Badge indicando fonte
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ— Frango, peito, sem pele...  â”‚â”‚  â† CartaoAlimento
â”‚  â”‚    Grupo C â€¢ TBCA               â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ ğŸ— Frango, coxa, com pele...   â”‚â”‚
â”‚  â”‚    Grupo C â€¢ TBCA               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fluxo de busca (com fallback):**
1. UsuÃ¡rio digita â†’ debounce 300ms
2. `GET /api/nutricao/alimentos/buscar?q=<termo>&limite=20`
3. Se retornar `[]`: fallback `GET /api/nutricao/tbca/alimentos?busca=<termo>&limite=50`
4. Exibir resultados (respeitar ordem da API â€” relevÃ¢ncia)
5. Ao tocar em um item â†’ navegar para `Confirmacao`

**Mapeamento de campos:**

| Fonte | Label | Id para associar |
|-------|-------|------------------|
| Base app (`/alimentos/buscar`) | `nome` (+`marca`) | `alimento_id` (int) |
| TBCA (`/tbca/alimentos`) | `descricao` | `alimento_tbca_id` (UUID) |

### 4.4 Tela: Confirmacao

**FunÃ§Ã£o:** Confirmar associaÃ§Ã£o do peso com o alimento selecionado.

**Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Voltar    Confirmar Registro      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                     â”‚
â”‚  Alimento:                          â”‚
â”‚  Frango, peito, sem pele, cozido    â”‚
â”‚                                     â”‚
â”‚  Peso:  124.5g                      â”‚
â”‚                                     â”‚
â”‚  RefeiÃ§Ã£o: [AlmoÃ§o â–¼]              â”‚  â† Picker de refeiÃ§Ã£o (opcional)
â”‚                                     â”‚
â”‚  ObservaÃ§Ã£o:                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                 â”‚â”‚  â† TextInput opcional
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚        âœ… Confirmar              â”‚â”‚  â† BotÃ£o principal
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚        âŒ Cancelar              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Fluxo:**
1. Exibe alimento + peso da pesagem pendente
2. UsuÃ¡rio seleciona refeiÃ§Ã£o (opcional) e adiciona observaÃ§Ã£o
3. Toca "Confirmar":
   - `POST /api/nutricao/diario/pesagens-pendentes/{pesagemId}/associar`
   - Body: `{ alimento_id | alimento_tbca_id, refeicao_id?, observacao? }`
4. Sucesso â†’ volta para `BalancaInteligente`, pesagem sai da fila
5. Erro â†’ exibe mensagem inline

---

## 5) IntegraÃ§Ã£o BLE â€” Protocolo ICOMON completo

### 5.1 Constantes

```typescript
// src/ble/constantes.ts

export const BALANCA_CONFIG = {
  MAC_ADDRESS: 'D0:4D:00:5C:F6:36',
  SERVICE_UUID: '0000ffb0-0000-1000-8000-00805f9b34fb',
  CHAR_WRITE_UUID: '0000ffb1-0000-1000-8000-00805f9b34fb',   // Write-No-Response
  CHAR_NOTIFY_UUID: '0000ffb2-0000-1000-8000-00805f9b34fb',  // Read + Notify
} as const;

// Comandos de ativaÃ§Ã£o (handshake obrigatÃ³rio)
// A balanÃ§a sÃ³ envia peso real apÃ³s receber estes comandos na FFB1
export const COMANDOS_ATIVACAO: string[] = [
  'AC010000000000000000000000AC',  // Init
  'AC030000000000000000000000AE',  // Start weighing
  'AC090100000000000000000000B6',  // Set unit: grams
];

// Mapa de unidades (formato 20 bytes â€” byte[3])
export const MAPA_UNIDADES_20B: Record<number, string> = {
  0x00: 'g',           // Peso mÃ©trico
  0x10: 'ml',          // Volume Ã¡gua mÃ©trico
  0x20: 'ml_milk',     // Volume leite mÃ©trico
  0x50: 'lb_oz',       // Peso imperial
  0x60: 'fl_oz',       // Volume Ã¡gua imperial
  0x70: 'fl_oz_milk',  // Volume leite imperial
};

// Mapa de unidades (formato 14 bytes â€” byte[2])
export const MAPA_UNIDADES_14B: Record<number, string> = {
  0x01: 'g',
  0x02: 'ml',
  0x03: 'ml_milk',
  0x04: 'oz',
  0x05: 'lb_oz',
};
```

### 5.2 DecodificaÃ§Ã£o do protocolo

```typescript
// src/ble/icomon.ts

import { MAPA_UNIDADES_14B, MAPA_UNIDADES_20B } from './constantes';

export interface LeituraBalanca {
  pesoGramas: number;      // Peso sempre em gramas
  unidade: string;         // Unidade selecionada no display
  estavel: boolean;        // Se o peso estÃ¡ estabilizado
  formato: '14B' | '20B'; // Formato do pacote recebido
  rawHex: string;          // Pacote bruto para debug
}

/**
 * Decodifica um pacote BLE da balanÃ§a ICOMON.
 * 
 * Formato 14 bytes (Android/BLE Scanner poll):
 *   byte[0]   = 0xAC (header)
 *   byte[1]   = flags (0x40 = estÃ¡vel)
 *   byte[2]   = cÃ³digo da unidade
 *   byte[3:5] = peso em decigramas (Little-Endian int16)
 *   byte[13]  = checksum
 * 
 * Formato 20 bytes (GATT direto / Linux):
 *   byte[0]   = 0xAC (header)
 *   byte[1]   = flags (0x40 = estÃ¡vel)
 *   byte[2]   = modo (0x00=ativo, 0x01=idle)
 *   byte[3]   = cÃ³digo modo+unidade (0x00=g, 0x10=ml, etc.)
 *   byte[4:7] = peso em miligramas (Big-Endian int24)
 *   byte[18:20] = checksum
 * 
 * IMPORTANTE: bytes[4:7] no formato 20B SEMPRE contÃ©m massa em
 * miligramas, independente da unidade selecionada no display.
 */
export function decodificarPacoteICOMON(bytes: Uint8Array): LeituraBalanca | null {
  // Validar header
  if (bytes[0] !== 0xAC) return null;

  const estavel = bytes[1] === 0x40;
  const rawHex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');

  if (bytes.length === 14) {
    // Formato 14 bytes: Little-Endian decigramas
    const unidadeCodigo = bytes[2];
    const rawPeso = bytes[3] | (bytes[4] << 8); // int16 LE
    const pesoGramas = rawPeso / 10;
    const unidade = MAPA_UNIDADES_14B[unidadeCodigo] ?? 'g';

    return { pesoGramas, unidade, estavel, formato: '14B', rawHex };
  }

  if (bytes.length === 20) {
    // Formato 20 bytes: Big-Endian miligramas
    const unidadeCodigo = bytes[3];
    const rawPeso = (bytes[4] << 16) | (bytes[5] << 8) | bytes[6]; // int24 BE
    const pesoGramas = rawPeso / 1000;
    const unidade = MAPA_UNIDADES_20B[unidadeCodigo] ?? 'g';

    return { pesoGramas, unidade, estavel, formato: '20B', rawHex };
  }

  return null;
}
```

### 5.3 Hook principal: useBalancaBLE

```typescript
// src/hooks/useBalancaBLE.ts

import { useEffect, useRef, useState, useCallback } from 'react';
import { BleManager, Device, Subscription } from 'react-native-ble-plx';
import { Platform, PermissionsAndroid } from 'react-native';
import { BALANCA_CONFIG, COMANDOS_ATIVACAO } from '../ble/constantes';
import { decodificarPacoteICOMON, LeituraBalanca } from '../ble/icomon';
import { base64ToBytes, hexToBase64 } from '../utils/codificacao';

export type StatusBLE = 'buscando' | 'conectando' | 'conectado' | 'desconectado';

interface UseBalancaBLEReturn {
  status: StatusBLE;
  leituraAtual: LeituraBalanca | null;
  reconectar: () => void;
  desconectar: () => void;
}

export function useBalancaBLE(): UseBalancaBLEReturn {
  const managerRef = useRef<BleManager | null>(null);
  const deviceRef = useRef<Device | null>(null);
  const subscriptionRef = useRef<Subscription | null>(null);

  const [status, setStatus] = useState<StatusBLE>('desconectado');
  const [leituraAtual, setLeituraAtual] = useState<LeituraBalanca | null>(null);

  // Solicitar permissÃµes BLE (Android 12+)
  const solicitarPermissoes = useCallback(async (): Promise<boolean> => {
    if (Platform.OS === 'android' && Platform.Version >= 31) {
      const resultado = await PermissionsAndroid.requestMultiple([
        PermissionsAndroid.PERMISSIONS.BLUETOOTH_SCAN,
        PermissionsAndroid.PERMISSIONS.BLUETOOTH_CONNECT,
        PermissionsAndroid.PERMISSIONS.ACCESS_FINE_LOCATION,
      ]);
      return Object.values(resultado).every(
        r => r === PermissionsAndroid.RESULTS.GRANTED
      );
    }
    if (Platform.OS === 'android') {
      const resultado = await PermissionsAndroid.request(
        PermissionsAndroid.PERMISSIONS.ACCESS_FINE_LOCATION
      );
      return resultado === PermissionsAndroid.RESULTS.GRANTED;
    }
    // iOS: permissÃµes via Info.plist (NSBluetoothAlwaysUsageDescription)
    return true;
  }, []);

  // Enviar comandos de ativaÃ§Ã£o (handshake)
  const enviarHandshake = useCallback(async (device: Device) => {
    for (const cmdHex of COMANDOS_ATIVACAO) {
      await device.writeCharacteristicWithoutResponseForService(
        BALANCA_CONFIG.SERVICE_UUID,
        BALANCA_CONFIG.CHAR_WRITE_UUID,
        hexToBase64(cmdHex)
      );
      // Pequeno delay entre comandos (50ms)
      await new Promise(r => setTimeout(r, 50));
    }
  }, []);

  // Iniciar monitoramento de peso (subscribe FFB2)
  const iniciarMonitoramento = useCallback((device: Device) => {
    subscriptionRef.current = device.monitorCharacteristicForService(
      BALANCA_CONFIG.SERVICE_UUID,
      BALANCA_CONFIG.CHAR_NOTIFY_UUID,
      (error, characteristic) => {
        if (error) {
          console.warn('[BLE] Erro no monitoramento:', error.message);
          setStatus('desconectado');
          return;
        }
        if (!characteristic?.value) return;

        const bytes = base64ToBytes(characteristic.value);
        const leitura = decodificarPacoteICOMON(bytes);

        if (leitura && leitura.estavel && leitura.pesoGramas > 0) {
          setLeituraAtual(leitura);
        }
      }
    );
  }, []);

  // Fluxo principal: scan â†’ connect â†’ handshake â†’ monitor
  const conectar = useCallback(async () => {
    const permitido = await solicitarPermissoes();
    if (!permitido) {
      console.warn('[BLE] PermissÃµes negadas');
      setStatus('desconectado');
      return;
    }

    if (!managerRef.current) {
      managerRef.current = new BleManager();
    }
    const manager = managerRef.current;

    // Estado 1: Buscando
    setStatus('buscando');
    setLeituraAtual(null);

    manager.startDeviceScan(
      [BALANCA_CONFIG.SERVICE_UUID],
      { allowDuplicates: false },
      async (error, device) => {
        if (error) {
          console.warn('[BLE] Erro no scan:', error.message);
          setStatus('desconectado');
          return;
        }

        // Filtrar pelo MAC da balanÃ§a
        if (!device || device.id !== BALANCA_CONFIG.MAC_ADDRESS) return;

        manager.stopDeviceScan();

        // Estado 2: Conectando
        setStatus('conectando');

        try {
          const connected = await device.connect({ timeout: 10000 });
          await connected.discoverAllServicesAndCharacteristics();

          deviceRef.current = connected;

          // Handshake: enviar comandos de ativaÃ§Ã£o para FFB1
          await enviarHandshake(connected);

          // Estado 3: Conectado â€” monitorar FFB2
          setStatus('conectado');
          iniciarMonitoramento(connected);

          // Detectar desconexÃ£o
          connected.onDisconnected((err) => {
            console.log('[BLE] Desconectado:', err?.message ?? 'pelo dispositivo');
            setStatus('desconectado');
            setLeituraAtual(null);
          });
        } catch (e: any) {
          console.warn('[BLE] Erro na conexÃ£o:', e.message);
          setStatus('desconectado');
        }
      }
    );

    // Timeout do scan: 15 segundos
    setTimeout(() => {
      if (status === 'buscando') {
        manager.stopDeviceScan();
        setStatus('desconectado');
      }
    }, 15000);
  }, [solicitarPermissoes, enviarHandshake, iniciarMonitoramento, status]);

  // Desconectar
  const desconectar = useCallback(async () => {
    subscriptionRef.current?.remove();
    managerRef.current?.stopDeviceScan();
    if (deviceRef.current) {
      try {
        await deviceRef.current.cancelConnection();
      } catch { /* jÃ¡ desconectado */ }
    }
    setStatus('desconectado');
    setLeituraAtual(null);
  }, []);

  // Reconectar
  const reconectar = useCallback(async () => {
    await desconectar();
    await conectar();
  }, [desconectar, conectar]);

  // Auto-conectar ao montar, desconectar ao desmontar
  useEffect(() => {
    conectar();
    return () => {
      desconectar();
      managerRef.current?.destroy();
    };
  }, []);

  return { status, leituraAtual, reconectar, desconectar };
}
```

### 5.4 UtilitÃ¡rios de codificaÃ§Ã£o

```typescript
// src/utils/codificacao.ts

/**
 * Converte hex string para Uint8Array.
 * Ex: "AC40" â†’ Uint8Array([0xAC, 0x40])
 */
export function hexToBytes(hex: string): Uint8Array {
  const bytes = new Uint8Array(hex.length / 2);
  for (let i = 0; i < hex.length; i += 2) {
    bytes[i / 2] = parseInt(hex.substring(i, i + 2), 16);
  }
  return bytes;
}

/**
 * Converte Uint8Array para hex string.
 */
export function bytesToHex(bytes: Uint8Array): string {
  return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
}

/**
 * Converte hex string para base64 (formato esperado por react-native-ble-plx).
 */
export function hexToBase64(hex: string): string {
  const bytes = hexToBytes(hex);
  // Em React Native, usar btoa ou Buffer
  const binary = String.fromCharCode(...bytes);
  return btoa(binary);
}

/**
 * Converte base64 (retornado por react-native-ble-plx) para Uint8Array.
 */
export function base64ToBytes(base64: string): Uint8Array {
  const binary = atob(base64);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  return bytes;
}
```

---

## 6) IntegraÃ§Ã£o com a API (endpoints reutilizados)

Todos os endpoints abaixo jÃ¡ existem no backend e sÃ£o os mesmos usados pelo web app.

### 6.1 AutenticaÃ§Ã£o

```
POST /api/auth/pair
Body: { "email": "...", "password": "..." }
Resp: { "access": "<JWT>", "refresh": "<REFRESH>" }

POST /api/auth/refresh
Body: { "refresh": "<REFRESH>" }
Resp: { "access": "<JWT_NOVO>" }
```

### 6.2 Registrar peso (sem alimento)

```
POST /api/nutricao/diario/balanca-cozinha
Headers: Authorization: Bearer <JWT>
Body: {
  "peso": 124.5,
  "unidade": "g",
  "mac_balanca": "D0:4D:00:5C:F6:36"
}
Resp 200: { "sucesso": true, "aguardando_alimento": true, ... }
```

### 6.3 Listar pesagens pendentes

```
GET /api/nutricao/diario/pesagens-pendentes
Headers: Authorization: Bearer <JWT>
Resp 200: { "pesagens": [...], "total": N }
```

### 6.4 Buscar alimento (base app)

```
GET /api/nutricao/alimentos/buscar?q=<termo>&limite=20
Headers: Authorization: Bearer <JWT>
Resp 200: [ { "id": 1, "nome": "...", ... } ]
```

### 6.5 Buscar alimento (TBCA â€” fallback)

```
GET /api/nutricao/tbca/alimentos?busca=<termo>&limite=50&offset=0
Headers: Authorization: Bearer <JWT>
Resp 200: [ { "id": "<UUID>", "descricao": "...", ... } ]
```

> **NÃ£o reordenar resultados!** A API jÃ¡ devolve ordenado por relevÃ¢ncia.

### 6.6 Associar pesagem a alimento

```
POST /api/nutricao/diario/pesagens-pendentes/{pesagemId}/associar
Headers: Authorization: Bearer <JWT>
Body (base app): { "alimento_id": 1, "refeicao_id": 2 }
Body (TBCA):     { "alimento_tbca_id": "<UUID>", "refeicao_id": 2 }
Resp 200: { "sucesso": true, "registro_alimentar": {...} }
```

### 6.7 Cancelar pesagem

```
DELETE /api/nutricao/diario/pesagens-pendentes/{pesagemId}
Headers: Authorization: Bearer <JWT>
Resp 200: { "sucesso": true, ... }
```

### 6.8 Listar refeiÃ§Ãµes (para picker)

```
GET /api/nutricao/refeicoes
Headers: Authorization: Bearer <JWT>
Resp 200: [ { "id": 1, "nome": "CafÃ© da manhÃ£", ... }, ... ]
```

---

## 7) Fluxo completo (ponta a ponta)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUXO COMPLETO                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. App abre â†’ Login (se JWT expirado) â†’ BalancaInteligente

2. Hook useBalancaBLE inicia:
   [Scan BLE] â”€â”€â–¶ Encontra D0:4D:00:5C:F6:36
              â”€â”€â–¶ device.connect()
              â”€â”€â–¶ discoverAllServicesAndCharacteristics()
              â”€â”€â–¶ write FFB1: init + start + set_unit
              â”€â”€â–¶ subscribe FFB2 (notify)
              â”€â”€â–¶ Status: âœ… Conectado

3. UsuÃ¡rio coloca alimento na balanÃ§a:
   [FFB2 notify] â”€â”€â–¶ decodificarPacoteICOMON(bytes)
                 â”€â”€â–¶ peso estÃ¡vel: 124.5g
                 â”€â”€â–¶ DisplayPeso atualiza: "124.5g"

4. App envia peso ao backend:
   POST /balanca-cozinha { peso: 124.5, unidade: "g", mac_balanca: "D0:4D:..." }
   â”€â”€â–¶ Backend cria PesagemPendente #7
   â”€â”€â–¶ Resp: { aguardando_alimento: true }

5. UsuÃ¡rio toca "Buscar alimento":
   â”€â”€â–¶ Navega para BuscaAlimento
   â”€â”€â–¶ Digita "frango" â†’ debounce 300ms
   â”€â”€â–¶ GET /alimentos/buscar?q=frango â†’ []  (base vazia)
   â”€â”€â–¶ Fallback: GET /tbca/alimentos?busca=frango&limite=50
   â”€â”€â–¶ Exibe lista: "Frango, peito, sem pele, cozido", etc.

6. UsuÃ¡rio seleciona "Frango, peito, sem pele, cozido":
   â”€â”€â–¶ Navega para Confirmacao
   â”€â”€â–¶ Exibe: alimento + peso + refeiÃ§Ã£o (picker)

7. UsuÃ¡rio toca "Confirmar":
   POST /pesagens-pendentes/7/associar {
     alimento_tbca_id: "550e8400-...",
     refeicao_id: 2,
     observacao: ""
   }
   â”€â”€â–¶ Backend cria RegistroAlimentar
   â”€â”€â–¶ Pesagem #7 sai da fila
   â”€â”€â–¶ Volta para BalancaInteligente (fila vazia)

8. Processo repete para prÃ³ximo ingrediente.
```

---

## 8) Indicador Bluetooth â€” 4 estados visuais

```typescript
// src/componentes/IndicadorBluetooth.tsx

import React from 'react';
import { View, Text, StyleSheet, ActivityIndicator } from 'react-native';
import { StatusBLE } from '../hooks/useBalancaBLE';

const CONFIG_STATUS = {
  buscando: {
    cor: '#3B82F6',    // Azul
    texto: 'Buscando balanÃ§a...',
    icone: 'ğŸ“¡',
    pulsando: true,
  },
  conectando: {
    cor: '#F59E0B',    // Amarelo
    texto: 'Conectando...',
    icone: 'ğŸ”—',
    pulsando: true,
  },
  conectado: {
    cor: '#10B981',    // Verde
    texto: 'Conectado',
    icone: 'âœ…',
    pulsando: false,
  },
  desconectado: {
    cor: '#EF4444',    // Vermelho
    texto: 'Desconectado',
    icone: 'âŒ',
    pulsando: false,
  },
};

interface Props {
  status: StatusBLE;
  pesoAtual?: number;
  onToque?: () => void;  // Para reconectar ao tocar
}

export function IndicadorBluetooth({ status, pesoAtual, onToque }: Props) {
  const config = CONFIG_STATUS[status];
  const texto = status === 'conectado' && pesoAtual
    ? `Peso: ${pesoAtual.toFixed(1)}g`
    : config.texto;

  return (
    <TouchableOpacity onPress={onToque} style={styles.container}>
      <View style={[styles.badge, { backgroundColor: config.cor + '20' }]}>
        {config.pulsando && <ActivityIndicator size="small" color={config.cor} />}
        <Text style={[styles.icone]}>{config.icone}</Text>
        <Text style={[styles.texto, { color: config.cor }]}>{texto}</Text>
      </View>
    </TouchableOpacity>
  );
}
```

---

## 9) PermissÃµes nativas

### iOS â€” Info.plist

```xml
<key>NSBluetoothAlwaysUsageDescription</key>
<string>O UNIO precisa de Bluetooth para conectar na balanÃ§a de cozinha.</string>
<key>NSBluetoothPeripheralUsageDescription</key>
<string>O UNIO precisa de Bluetooth para conectar na balanÃ§a de cozinha.</string>
```

### Android â€” AndroidManifest.xml

```xml
<!-- Android 12+ (API 31+) -->
<uses-permission android:name="android.permission.BLUETOOTH_SCAN" />
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />

<!-- Android 11 e inferior -->
<uses-permission android:name="android.permission.BLUETOOTH" />
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />

<!-- Declarar uso de BLE -->
<uses-feature android:name="android.hardware.bluetooth_le" android:required="true" />
```

---

## 10) Setup do projeto

### InicializaÃ§Ã£o

```bash
# 1. Criar projeto React Native (bare workflow)
npx @react-native-community/cli init UnioBalanca --template react-native-template-typescript

# 2. Instalar dependÃªncias
cd UnioBalanca
npm install react-native-ble-plx
npm install @react-navigation/native @react-navigation/stack
npm install react-native-screens react-native-safe-area-context
npm install @react-native-async-storage/async-storage
npm install zustand
npm install axios

# 3. Link nativo (iOS)
cd ios && pod install && cd ..

# 4. Configurar permissÃµes (ver seÃ§Ã£o 9)

# 5. Rodar
npx react-native run-ios
npx react-native run-android
```

### VariÃ¡veis de ambiente

```
# .env
API_BASE_URL=https://staging.unio.tec.br
# Em produÃ§Ã£o: https://api.unio.tec.br
```

---

## 11) Checklist de entrega (MVP)

- [ ] Projeto React Native criado e buildando (iOS + Android)
- [ ] `react-native-ble-plx` integrado e permissÃµes configuradas
- [ ] Tela Login funcional (JWT persistido em AsyncStorage)
- [ ] Hook `useBalancaBLE` conectando na balanÃ§a D0:4D:00:5C:F6:36
- [ ] Handshake ICOMON (3 comandos FFB1) funcionando
- [ ] DecodificaÃ§Ã£o de peso (14B e 20B) funcionando
- [ ] Indicador Bluetooth com 4 estados visuais
- [ ] `POST /balanca-cozinha` enviando peso ao backend
- [ ] Tela BuscaAlimento com fallback TBCA
- [ ] Tela Confirmacao associando pesagem ao alimento
- [ ] Fila de pesagens pendentes funcional
- [ ] `DELETE /pesagens-pendentes/{id}` (cancelar)
- [ ] Refresh automÃ¡tico de JWT
- [ ] Testado em dispositivo fÃ­sico (BLE nÃ£o funciona no simulador)

---

## 12) ObservaÃ§Ãµes importantes

1. **BLE nÃ£o funciona em simuladores/emuladores.** Testar sempre em dispositivo fÃ­sico.
2. O **MAC address pode variar no iOS** â€” o iOS randomiza o MAC. Usar `serviceUUIDs` como filtro principal no scan, e o MAC como fallback (Android).
3. A balanÃ§a **desliga apÃ³s ~2 minutos** sem atividade. O hook deve detectar desconexÃ£o e oferecer reconexÃ£o.
4. O backend aceita tanto `peso` + `unidade` quanto `pacote_hex` (raw). Use `peso` + `unidade` (mais simples) a menos que queira logging de debug via raw hex.
5. O **script Python** (`scanner_balanca_icomon.py`) continua funcional para testes em Linux â€” pode ser Ãºtil durante o desenvolvimento para validar que o backend estÃ¡ recebendo dados corretamente.

---

## 13) ReferÃªncias

| Recurso | Link/Path |
|---------|-----------|
| Arquitetura UNIO | `docs/ARQUITETURA_INICIAL.md` |
| Protocolo ICOMON completo | `docs/BALANCA_COZINHA.md` |
| Parser Python (referÃªncia) | `apps/nutricao/icomon.py` |
| Scanner Python (testes) | `scripts/scanner_balanca_icomon.py` |
| Schemas Pydantic | `apps/nutricao/schemas.py` |
| Endpoints API | `apps/nutricao/api.py` |
| Handoff web app (Replit) | `docs/especificacoes/balanca_inteligente_handoff_replit.md` |
| react-native-ble-plx docs | https://github.com/dotintent/react-native-ble-plx |

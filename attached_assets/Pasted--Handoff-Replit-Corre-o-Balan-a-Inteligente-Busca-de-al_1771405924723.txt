# Handoff Replit — Correção “Balança Inteligente” (Busca de alimentos)

**Data:** 18/02/2026  
**Responsável backend:** time UNIO (este repositório)  
**Responsável Replit:** correção do frontend e integração HTTP

---

## 1) Problema reportado

Na tela **Balança Inteligente**, ao pesquisar por um alimento no campo “Buscar alimento (ex: Frango)”, **não retorna resultados**.

Causa mais comum: frontend chamando endpoint/parâmetros errados, sem JWT, ou consultando apenas a base `Alimento` (que pode estar vazia em alguns ambientes) em vez de usar TBCA.

---

## 1.1 Fluxo correto (obrigatório) para a tela “Balança Inteligente”

> Este é o fluxo que o frontend deve seguir. Ele é diferente do “buscar → escolher quantidade → POST genérico”.

### Estado 1: receber peso (sem alimento ainda)

1. Balança/integração fornece `peso` e `unidade` (ou `pacote_hex`).
2. Frontend chama:
  - `POST /api/nutricao/diario/balanca-cozinha`
3. Se o frontend ainda não informou alimento, o backend responde `200` com:
  - `aguardando_alimento: true`
  - mensagem informando que a pesagem foi enfileirada

> Importante: o ID da pesagem pendente **não vem** nesta resposta. Para obter o `pesagemId`, o frontend deve chamar a fila.

### Estado 2: obter a pesagem pendente atual

4. Frontend chama:
  - `GET /api/nutricao/diario/pesagens-pendentes`
5. Usar a pesagem mais recente (`pesagens[0]`) como “peso atual” (se houver).

### Estado 3: usuário busca alimento (com fallback)

6. Quando usuário digitar no campo de busca:
  - primeira tentativa: `GET /api/nutricao/alimentos/buscar?q=<termo>&limite=20`
  - se retornar `[]` (ou total muito baixo, conforme decisão de produto), fazer fallback:
    - `GET /api/nutricao/tbca/alimentos?busca=<termo>&limite=50&offset=0`

> TBCA tem schema diferente: usar `descricao` (não `nome`) e o `id` é UUID.

### Estado 4: associar a pesagem ao alimento escolhido (finaliza)

7. Ao selecionar um item, chamar:
  - `POST /api/nutricao/diario/pesagens-pendentes/{pesagemId}/associar`
8. Enviar:
  - se item veio de `/alimentos/buscar`: `{"alimento_id": <int>}`
  - se item veio de `/tbca/alimentos`: `{"alimento_tbca_id": "<uuid>"}`
9. Em sucesso: pesagem sai da fila (status deixa de ser `PENDENTE`) e o registro alimentar é criado.

### O que remover (para corrigir o bug)

- Remover **mock fixo** de “124g” na UI.
- Remover o fluxo de “salvar” usando `POST /api/nutricao/diario/registrar` como caminho principal desta tela.
  - Esse endpoint existe e continua válido para registro manual no diário, mas **não** é o fluxo correto da balança.

---

## 2) Endpoints que a tela deve usar

> Todos os endpoints abaixo exigem JWT.

### 2.1 Busca de alimentos (base do app: `Alimento`)

Use este endpoint para autocompletar/seleção rápida:

- `GET /api/nutricao/alimentos/buscar?q=<termo>&limite=20`

**Headers obrigatórios:**
- `Authorization: Bearer <JWT>`

**Parâmetros:**
- `q` (string, obrigatório): termo de busca (nome ou marca)
- `limite` (int, opcional, default=20)

**Resposta (200):** lista de `AlimentoSchema`.

Observação importante:
- Esse endpoint busca **somente** na tabela `Alimento` (nome/marca). Se a base estiver vazia no ambiente, a resposta será `[]`.


### 2.2 Busca de alimentos (TBCA: base ampla)

Use este endpoint como **fallback** quando `alimentos/buscar` retornar vazio (ou já como fonte principal, se o produto preferir):

- `GET /api/nutricao/tbca/alimentos?busca=<termo>&limite=50&offset=0`

**Headers obrigatórios:**
- `Authorization: Bearer <JWT>`

**Parâmetros:**
- `busca` (string, opcional): termo aplicado em `descricao__icontains`
- `limite` (int, opcional, default=50)
- `offset` (int, opcional, default=0)
- `grupo` (string, opcional): código do grupo (ex.: `C`, `F`)
- `fonte` (string, opcional)

**Resposta (200):** lista de `AlimentoTBCAResumoSchema`.


### 2.3 Fluxo principal da balança (entrada de peso)

A tela da balança deve registrar as leituras (peso) neste endpoint:

- `POST /api/nutricao/diario/balanca-cozinha`

Se o frontend **não tiver alimento selecionado ainda**, o backend retorna `aguardando_alimento=true` e cria uma **pesagem pendente**.


### 2.4 Listar fila de pesagens pendentes

- `GET /api/nutricao/diario/pesagens-pendentes`

Use para exibir/recuperar o “peso atual” que está aguardando alimento.


### 2.5 Associar a pesagem a um alimento escolhido

Depois que o usuário escolhe um alimento na busca, finalize a pesagem pendente:

- `POST /api/nutricao/diario/pesagens-pendentes/{pesagemId}/associar`

**Body:** informar **exatamente um** dos campos abaixo:
- `alimento_id` (int) **OU**
- `alimento_tbca_id` (UUID)

Campos opcionais:
- `refeicao_id` (int)
- `observacao` (string)


### 2.6 Descartar pesagem pendente

Se usuário cancelar:

- `DELETE /api/nutricao/diario/pesagens-pendentes/{pesagemId}`


### 2.7 Salvar/registrar alimento no diário (fluxo manual)

Se a tela precisar **registrar o consumo** diretamente no diário (fora do fluxo “pesagem pendente”), use:

- `POST /api/nutricao/diario/registrar`

**Headers obrigatórios:**
- `Authorization: Bearer <JWT>`
- `Content-Type: application/json`

**Body (Schema: `RegistrarAlimentoSchema`):**
- `alimento_id` (int, obrigatório)
- `quantidade` (float, obrigatório) — em g/ml/unidades (depende do alimento)
- `refeicao_id` (int, opcional)
- `data_consumo` (datetime ISO, opcional)
- `observacao` (string, opcional)


### 2.8 Atalho: registrar via balança já com alimento selecionado

Se o frontend já tiver **peso** e o usuário já tiver escolhido o alimento, dá para registrar em **uma chamada**:

- `POST /api/nutricao/diario/balanca-cozinha`

Nesse caso, envie `peso` + `unidade` **e** `alimento_id` (ou `codigo_barras`).
O backend retorna `201` e `aguardando_alimento=false`.

---

## 3) Regras de integração (muito importantes)

- **JWT obrigatório** em todos os endpoints acima. Sem JWT, a busca pode retornar `401` e a UI parecer “sem resultados”.
- Não confundir parâmetros:
  - `GET /alimentos/buscar` usa **`q`** (não é `busca`).
  - `GET /tbca/alimentos` usa **`busca`** (não é `q`).
- A busca `GET /api/nutricao/alimentos/buscar` consulta apenas a tabela `Alimento`.
  - Em ambientes novos/staging, ela pode estar vazia.
  - Nesses casos, **implementar fallback para TBCA**.

### 3.1 Mapeamento de UI (base app vs TBCA)

- Item da base do app (`/alimentos/buscar`):
  - label: `nome` (pode incluir `marca` se existir)
  - identificador: `id` (int) → usar como `alimento_id`
- Item da TBCA (`/tbca/alimentos`):
  - label: `descricao`
  - identificador: `id` (UUID) → usar como `alimento_tbca_id`

---

## 4) Exemplos prontos (copiar/colar)

### 4.1 Buscar alimento (base do app)

`GET /api/nutricao/alimentos/buscar?q=frango&limite=20`

Resposta (exemplo):
```json
[
  {
    "id": 1,
    "nome": "Peito de frango",
    "marca": "",
    "calorias": 165,
    "carboidratos": 0,
    "proteinas": 31,
    "gorduras": 3.6,
    "fibras": 0,
    "codigo_barras": null,
    "unidade_medida": "G"
  }
]
```

### 4.2 Buscar alimento (TBCA)

`GET /api/nutricao/tbca/alimentos?busca=frango&limite=50&offset=0`

Resposta (exemplo):
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "codigo_tbca": "BRC0001C",
    "descricao": "Frango, peito, sem pele, cozido",
    "nome_cientifico": null,
    "grupo_alimentar": {"id": "...", "codigo_tbca": "C", "nome": "Carnes e derivados"},
    "fonte_dados": "TBCA"
  }
]
```

### 4.3 Registrar leitura da balança (sem alimento ainda)

`POST /api/nutricao/diario/balanca-cozinha`

Body (exemplo):
```json
{
  "peso": 124,
  "unidade": "g",
  "mac_balanca": "D0:4D:00:5C:F6:36"
}
```

Resposta típica (aguardando alimento):
```json
{
  "sucesso": true,
  "registro_id": null,
  "alimento_nome": null,
  "peso_original": 124,
  "unidade_original": "g",
  "peso_gramas": 124,
  "calorias_consumidas": null,
  "mensagem": "Peso 124g (124g) salvo na fila (ID #3). Associe a um alimento.",
  "aguardando_alimento": true
}
```

### 4.4 Listar pendências

`GET /api/nutricao/diario/pesagens-pendentes`

Resposta (exemplo):
```json
{
  "pesagens": [
    {
      "id": 3,
      "peso_original": 124.0,
      "unidade_original": "g",
      "peso_gramas": 124.0,
      "status": "PENDENTE",
      "mac_balanca": "D0:4D:00:5C:F6:36",
      "pesado_em": "2026-02-18T10:30:00Z",
      "associado_em": null,
      "registro_alimentar_id": null
    }
  ],
  "total": 1
}
```

### 4.5 Associar pendência usando `alimento_id`

`POST /api/nutricao/diario/pesagens-pendentes/3/associar`

Body:
```json
{
  "alimento_id": 1,
  "refeicao_id": 2,
  "observacao": "Selecionado na tela da balança"
}
```

### 4.6 Associar pendência usando `alimento_tbca_id`

`POST /api/nutricao/diario/pesagens-pendentes/3/associar`

Body:
```json
{
  "alimento_tbca_id": "550e8400-e29b-41d4-a716-446655440000",
  "refeicao_id": 2,
  "observacao": "Selecionado na TBCA"
}
```

### 4.7 Registrar alimento manualmente no diário

`POST /api/nutricao/diario/registrar`

Body (exemplo):
```json
{
  "alimento_id": 1,
  "quantidade": 124,
  "refeicao_id": 2,
  "observacao": "Registrado manualmente na tela da balança"
}
```

Resposta (201, exemplo):
```json
{
  "id": 10,
  "alimento_nome": "Peito de frango",
  "quantidade": 124.0,
  "calorias_consumidas": 204.6,
  "mensagem": "Peito de frango registrado com sucesso"
}
```

### 4.8 Registrar via balança já com `alimento_id` (sem pendência)

`POST /api/nutricao/diario/balanca-cozinha`

Body (exemplo):
```json
{
  "peso": 124,
  "unidade": "g",
  "alimento_id": 1,
  "refeicao_id": 2,
  "mac_balanca": "D0:4D:00:5C:F6:36"
}
```

Resposta típica (201, exemplo):
```json
{
  "sucesso": true,
  "registro_id": 11,
  "alimento_nome": "Peito de frango",
  "peso_original": 124,
  "unidade_original": "g",
  "peso_gramas": 124,
  "calorias_consumidas": 204.6,
  "mensagem": "Peito de frango (124g) registrado automaticamente",
  "aguardando_alimento": false
}
```

---

## 5) Checklist de debug para o Replit

1. Confirmar que a request de busca está indo para **o endpoint certo**:
   - App/base: `/api/nutricao/alimentos/buscar?q=...`
   - TBCA: `/api/nutricao/tbca/alimentos?busca=...`
2. Confirmar que está enviando `Authorization: Bearer <JWT>`.
3. Logar no console:
   - URL final (com querystring)
   - status code
   - body retornado
4. Se `/alimentos/buscar` estiver retornando `[]` consistentemente:
   - Implementar fallback para `/tbca/alimentos`.
5. Verificar se há debounce no campo de busca (evitar chamar com string vazia).

---

## 6) Referências no backend

- Endpoint busca `Alimento`: `GET /api/nutricao/alimentos/buscar` (parâmetro `q`) — implementado em [apps/nutricao/api.py](apps/nutricao/api.py).
- Endpoint TBCA: `GET /api/nutricao/tbca/alimentos` (parâmetro `busca`) — implementado em [apps/nutricao/api.py](apps/nutricao/api.py).
- Fluxo balança + pendências: documentado em [docs/BALANCA_COZINHA.md](docs/BALANCA_COZINHA.md).
